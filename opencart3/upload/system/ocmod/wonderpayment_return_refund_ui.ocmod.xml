<?xml version="1.0" encoding="utf-8"?>
<modification>
  <name>WonderPayment Return Refund UI</name>
  <code>wonderpayment_return_refund_ui</code>
  <version>1.0.0</version>
  <author>WonderPayment</author>
  <link></link>
  <file path="admin/controller/sale/return.php">
    <operation>
      <search><![CDATA[<?php]]></search>
      <add position="replace"><![CDATA[<?php
class ControllerSaleReturn extends Controller {
	private $error = array();

	public function index() {
		$this->load->language('sale/return');

		$this->document->setTitle($this->language->get('heading_title'));

		$this->load->model('sale/return');

		$this->getList();
	}


	public function add() {
		$this->load->language('sale/return');

		$this->document->setTitle($this->language->get('heading_title'));

		$this->load->model('sale/return');

		if (($this->request->server['REQUEST_METHOD'] == 'POST') && $this->validateForm()) {
			$this->model_sale_return->addReturn($this->request->post);

			$this->session->data['success'] = $this->language->get('text_success');

			$url = '';

			if (isset($this->request->get['filter_return_id'])) {
				$url .= '&filter_return_id=' . $this->request->get['filter_return_id'];
			}

			if (isset($this->request->get['filter_order_id'])) {
				$url .= '&filter_order_id=' . $this->request->get['filter_order_id'];
			}

			if (isset($this->request->get['filter_customer'])) {
				$url .= '&filter_customer=' . urlencode(html_entity_decode($this->request->get['filter_customer'], ENT_QUOTES, 'UTF-8'));
			}

			if (isset($this->request->get['filter_product'])) {
				$url .= '&filter_product=' . urlencode(html_entity_decode($this->request->get['filter_product'], ENT_QUOTES, 'UTF-8'));
			}

			if (isset($this->request->get['filter_model'])) {
				$url .= '&filter_model=' . urlencode(html_entity_decode($this->request->get['filter_model'], ENT_QUOTES, 'UTF-8'));
			}

			if (isset($this->request->get['filter_return_status_id'])) {
				$url .= '&filter_return_status_id=' . $this->request->get['filter_return_status_id'];
			}

			if (isset($this->request->get['filter_date_added'])) {
				$url .= '&filter_date_added=' . $this->request->get['filter_date_added'];
			}

			if (isset($this->request->get['filter_date_modified'])) {
				$url .= '&filter_date_modified=' . $this->request->get['filter_date_modified'];
			}

			if (isset($this->request->get['sort'])) {
				$url .= '&sort=' . $this->request->get['sort'];
			}

			if (isset($this->request->get['order'])) {
				$url .= '&order=' . $this->request->get['order'];
			}

			if (isset($this->request->get['page'])) {
				$url .= '&page=' . $this->request->get['page'];
			}

			$this->response->redirect($this->url->link('sale/return', 'user_token=' . $this->session->data['user_token'] . $url, true));
		}

		$this->getForm();
	}

	public function edit() {
		$this->load->language('sale/return');

		$this->document->setTitle($this->language->get('heading_title'));

		$this->load->model('sale/return');

		if (($this->request->server['REQUEST_METHOD'] == 'POST') && $this->validateForm()) {
			$this->model_sale_return->editReturn($this->request->get['return_id'], $this->request->post);

			$this->session->data['success'] = $this->language->get('text_success');

			$url = '';

			if (isset($this->request->get['filter_return_id'])) {
				$url .= '&filter_return_id=' . $this->request->get['filter_return_id'];
			}

			if (isset($this->request->get['filter_order_id'])) {
				$url .= '&filter_order_id=' . $this->request->get['filter_order_id'];
			}

			if (isset($this->request->get['filter_customer'])) {
				$url .= '&filter_customer=' . urlencode(html_entity_decode($this->request->get['filter_customer'], ENT_QUOTES, 'UTF-8'));
			}

			if (isset($this->request->get['filter_product'])) {
				$url .= '&filter_product=' . urlencode(html_entity_decode($this->request->get['filter_product'], ENT_QUOTES, 'UTF-8'));
			}

			if (isset($this->request->get['filter_model'])) {
				$url .= '&filter_model=' . urlencode(html_entity_decode($this->request->get['filter_model'], ENT_QUOTES, 'UTF-8'));
			}

			if (isset($this->request->get['filter_return_status_id'])) {
				$url .= '&filter_return_status_id=' . $this->request->get['filter_return_status_id'];
			}

			if (isset($this->request->get['filter_date_added'])) {
				$url .= '&filter_date_added=' . $this->request->get['filter_date_added'];
			}

			if (isset($this->request->get['filter_date_modified'])) {
				$url .= '&filter_date_modified=' . $this->request->get['filter_date_modified'];
			}

			if (isset($this->request->get['sort'])) {
				$url .= '&sort=' . $this->request->get['sort'];
			}

			if (isset($this->request->get['order'])) {
				$url .= '&order=' . $this->request->get['order'];
			}

			if (isset($this->request->get['page'])) {
				$url .= '&page=' . $this->request->get['page'];
			}

			$this->response->redirect($this->url->link('sale/return', 'user_token=' . $this->session->data['user_token'] . $url, true));
		}

		$this->getForm();
	}

	public function delete() {
		$this->load->language('sale/return');

		$this->document->setTitle($this->language->get('heading_title'));

		$this->load->model('sale/return');

		if (isset($this->request->post['selected']) && $this->validateDelete()) {
			foreach ($this->request->post['selected'] as $return_id) {
				$this->model_sale_return->deleteReturn($return_id);
			}

			$this->session->data['success'] = $this->language->get('text_success');

			$url = '';

			if (isset($this->request->get['filter_return_id'])) {
				$url .= '&filter_return_id=' . $this->request->get['filter_return_id'];
			}

			if (isset($this->request->get['filter_order_id'])) {
				$url .= '&filter_order_id=' . $this->request->get['filter_order_id'];
			}

			if (isset($this->request->get['filter_customer'])) {
				$url .= '&filter_customer=' . urlencode(html_entity_decode($this->request->get['filter_customer'], ENT_QUOTES, 'UTF-8'));
			}

			if (isset($this->request->get['filter_product'])) {
				$url .= '&filter_product=' . urlencode(html_entity_decode($this->request->get['filter_product'], ENT_QUOTES, 'UTF-8'));
			}

			if (isset($this->request->get['filter_model'])) {
				$url .= '&filter_model=' . urlencode(html_entity_decode($this->request->get['filter_model'], ENT_QUOTES, 'UTF-8'));
			}

			if (isset($this->request->get['filter_return_status_id'])) {
				$url .= '&filter_return_status_id=' . $this->request->get['filter_return_status_id'];
			}

			if (isset($this->request->get['filter_date_added'])) {
				$url .= '&filter_date_added=' . $this->request->get['filter_date_added'];
			}

			if (isset($this->request->get['filter_date_modified'])) {
				$url .= '&filter_date_modified=' . $this->request->get['filter_date_modified'];
			}

			if (isset($this->request->get['sort'])) {
				$url .= '&sort=' . $this->request->get['sort'];
			}

			if (isset($this->request->get['order'])) {
				$url .= '&order=' . $this->request->get['order'];
			}

			if (isset($this->request->get['page'])) {
				$url .= '&page=' . $this->request->get['page'];
			}

			$this->response->redirect($this->url->link('sale/return', 'user_token=' . $this->session->data['user_token'] . $url, true));
		}

		$this->getList();
	}

	protected function getList() {
		$this->load->language('extension/payment/wonderpayment');

		if (isset($this->request->get['filter_return_id'])) {
			$filter_return_id = $this->request->get['filter_return_id'];
		} else {
			$filter_return_id = '';
		}

		if (isset($this->request->get['filter_order_id'])) {
			$filter_order_id = $this->request->get['filter_order_id'];
		} else {
			$filter_order_id = '';
		}

		if (isset($this->request->get['filter_customer'])) {
			$filter_customer = $this->request->get['filter_customer'];
		} else {
			$filter_customer = '';
		}

		if (isset($this->request->get['filter_product'])) {
			$filter_product = $this->request->get['filter_product'];
		} else {
			$filter_product = '';
		}

		if (isset($this->request->get['filter_model'])) {
			$filter_model = $this->request->get['filter_model'];
		} else {
			$filter_model = '';
		}

		if (isset($this->request->get['filter_return_status_id'])) {
			$filter_return_status_id = $this->request->get['filter_return_status_id'];
		} else {
			$filter_return_status_id = '';
		}

		if (isset($this->request->get['filter_date_added'])) {
			$filter_date_added = $this->request->get['filter_date_added'];
		} else {
			$filter_date_added = '';
		}

		if (isset($this->request->get['filter_date_modified'])) {
			$filter_date_modified = $this->request->get['filter_date_modified'];
		} else {
			$filter_date_modified = '';
		}

		if (isset($this->request->get['sort'])) {
			$sort = $this->request->get['sort'];
		} else {
			$sort = 'r.return_id';
		}

		if (isset($this->request->get['order'])) {
			$order = $this->request->get['order'];
		} else {
			$order = 'DESC';
		}

		if (isset($this->request->get['page'])) {
			$page = (int)$this->request->get['page'];
		} else {
			$page = 1;
		}

		$url = '';

		if (isset($this->request->get['filter_return_id'])) {
			$url .= '&filter_return_id=' . $this->request->get['filter_return_id'];
		}

		if (isset($this->request->get['filter_order_id'])) {
			$url .= '&filter_order_id=' . $this->request->get['filter_order_id'];
		}

		if (isset($this->request->get['filter_customer'])) {
			$url .= '&filter_customer=' . urlencode(html_entity_decode($this->request->get['filter_customer'], ENT_QUOTES, 'UTF-8'));
		}

		if (isset($this->request->get['filter_product'])) {
			$url .= '&filter_product=' . urlencode(html_entity_decode($this->request->get['filter_product'], ENT_QUOTES, 'UTF-8'));
		}

		if (isset($this->request->get['filter_model'])) {
			$url .= '&filter_model=' . urlencode(html_entity_decode($this->request->get['filter_model'], ENT_QUOTES, 'UTF-8'));
		}

		if (isset($this->request->get['filter_return_status_id'])) {
			$url .= '&filter_return_status_id=' . $this->request->get['filter_return_status_id'];
		}

		if (isset($this->request->get['filter_date_added'])) {
			$url .= '&filter_date_added=' . $this->request->get['filter_date_added'];
		}

		if (isset($this->request->get['filter_date_modified'])) {
			$url .= '&filter_date_modified=' . $this->request->get['filter_date_modified'];
		}

		if (isset($this->request->get['sort'])) {
			$url .= '&sort=' . $this->request->get['sort'];
		}

		if (isset($this->request->get['order'])) {
			$url .= '&order=' . $this->request->get['order'];
		}

		if (isset($this->request->get['page'])) {
			$url .= '&page=' . $this->request->get['page'];
		}

		$data['breadcrumbs'] = array();

		$data['breadcrumbs'][] = array(
			'text' => $this->language->get('text_home'),
			'href' => $this->url->link('common/dashboard', 'user_token=' . $this->session->data['user_token'], true)
		);

		$data['breadcrumbs'][] = array(
			'text' => $this->language->get('heading_title'),
			'href' => $this->url->link('sale/return', 'user_token=' . $this->session->data['user_token'] . $url, true)
		);

		$data['add'] = $this->url->link('sale/return/add', 'user_token=' . $this->session->data['user_token'] . $url, true);
		$data['delete'] = $this->url->link('sale/return/delete', 'user_token=' . $this->session->data['user_token'] . $url, true);

		$data['returns'] = array();

		$filter_data = array(
			'filter_return_id'        => $filter_return_id,
			'filter_order_id'         => $filter_order_id,
			'filter_customer'         => $filter_customer,
			'filter_product'          => $filter_product,
			'filter_model'            => $filter_model,
			'filter_return_status_id' => $filter_return_status_id,
			'filter_date_added'       => $filter_date_added,
			'filter_date_modified'    => $filter_date_modified,
			'sort'                    => $sort,
			'order'                   => $order,
			'start'                   => ($page - 1) * $this->config->get('config_limit_admin'),
			'limit'                   => $this->config->get('config_limit_admin')
		);

		$return_total = $this->model_sale_return->getTotalReturns($filter_data);

		$results = $this->model_sale_return->getReturns($filter_data);

		// 加载所需的模型
		$this->load->model('sale/order');
		$this->load->model('extension/payment/wonderpayment');

		foreach ($results as $result) {
			// 获取订单信息
			$order_info = $this->model_sale_order->getOrder($result['order_id']);

			// 动态计算退款状态
			$return_status = $result['return_status'];
			$return_status_id = $result['return_status_id'];
			$return_action_id = $result['return_action_id'];

			// 检查是否使用 WonderPayment 支付
			if ($order_info && $order_info['payment_code'] === 'wonderpayment') {
				// 获取已退款总额（原始货币）
				$settlement_currency = $order_info['currency_code'];
				$rate = 1;
				$this->model_extension_payment_wonderpayment->ensureRefundSchema();
				$summary = $this->model_extension_payment_wonderpayment->getRefundSummary($result['order_id'], $order_info['currency_code'], $settlement_currency, $rate);
				$total_refunded = $summary['total_original'];

				// 根据退款情况更新状态显示
				if ($total_refunded > 0) {
					if ($total_refunded >= $order_info['total']) {
						// 全额退款
						$return_status = 'Refunded';
						$return_status_id = 3; // Complete 状态
						$return_action_id = 1; // Refunded 操作
					} else {
						// 部分退款
						$return_status = 'Partially Refunded';
					}
				}
			}

			$data['returns'][] = array(
				'return_id'        => $result['return_id'],
				'order_id'         => $result['order_id'],
				'customer'         => $result['customer'],
				'product'          => $result['product'],
				'model'            => $result['model'],
				'return_status'    => $return_status,
				'return_status_id' => $return_status_id,
				'return_action_id' => $return_action_id,
				'date_added'       => date($this->language->get('date_format_short'), strtotime($result['date_added'])),
				'date_modified'    => date($this->language->get('date_format_short'), strtotime($result['date_modified'])),
				'edit'             => $this->url->link('sale/return/edit', 'user_token=' . $this->session->data['user_token'] . '&return_id=' . $result['return_id'] . $url, true),
				'refund'           => $this->url->link('sale/return/refund', 'user_token=' . $this->session->data['user_token'] . '&return_id=' . $result['return_id'] . '&order_id=' . $result['order_id'] . $url, true)
			);
		}

		$data['user_token'] = $this->session->data['user_token'];

		if (isset($this->session->data['error'])) {
			$data['error_warning'] = $this->session->data['error'];

			unset($this->session->data['error']);
		} elseif (isset($this->error['warning'])) {
			$data['error_warning'] = $this->error['warning'];
		} else {
			$data['error_warning'] = '';
		}

		if (isset($this->session->data['success'])) {
			$data['success'] = $this->session->data['success'];

			unset($this->session->data['success']);
		} else {
			$data['success'] = '';
		}

		if (isset($this->request->post['selected'])) {
			$data['selected'] = (array)$this->request->post['selected'];
		} else {
			$data['selected'] = array();
		}

		$url = '';

		if (isset($this->request->get['filter_return_id'])) {
			$url .= '&filter_return_id=' . $this->request->get['filter_return_id'];
		}

		if (isset($this->request->get['filter_order_id'])) {
			$url .= '&filter_order_id=' . $this->request->get['filter_order_id'];
		}

		if (isset($this->request->get['filter_customer'])) {
			$url .= '&filter_customer=' . urlencode(html_entity_decode($this->request->get['filter_customer'], ENT_QUOTES, 'UTF-8'));
		}

		if (isset($this->request->get['filter_product'])) {
			$url .= '&filter_product=' . urlencode(html_entity_decode($this->request->get['filter_product'], ENT_QUOTES, 'UTF-8'));
		}

		if (isset($this->request->get['filter_model'])) {
			$url .= '&filter_model=' . urlencode(html_entity_decode($this->request->get['filter_model'], ENT_QUOTES, 'UTF-8'));
		}

		if (isset($this->request->get['filter_return_status_id'])) {
			$url .= '&filter_return_status_id=' . $this->request->get['filter_return_status_id'];
		}

		if (isset($this->request->get['filter_date_added'])) {
			$url .= '&filter_date_added=' . $this->request->get['filter_date_added'];
		}

		if (isset($this->request->get['filter_date_modified'])) {
			$url .= '&filter_date_modified=' . $this->request->get['filter_date_modified'];
		}

		if ($order == 'ASC') {
			$url .= '&order=DESC';
		} else {
			$url .= '&order=ASC';
		}

		if (isset($this->request->get['page'])) {
			$url .= '&page=' . $this->request->get['page'];
		}

		$data['sort_return_id'] = $this->url->link('sale/return', 'user_token=' . $this->session->data['user_token'] . '&sort=r.return_id' . $url, true);
		$data['sort_order_id'] = $this->url->link('sale/return', 'user_token=' . $this->session->data['user_token'] . '&sort=r.order_id' . $url, true);
		$data['sort_customer'] = $this->url->link('sale/return', 'user_token=' . $this->session->data['user_token'] . '&sort=customer' . $url, true);
		$data['sort_product'] = $this->url->link('sale/return', 'user_token=' . $this->session->data['user_token'] . '&sort=r.product' . $url, true);
		$data['sort_model'] = $this->url->link('sale/return', 'user_token=' . $this->session->data['user_token'] . '&sort=r.model' . $url, true);
		$data['sort_status'] = $this->url->link('sale/return', 'user_token=' . $this->session->data['user_token'] . '&sort=status' . $url, true);
		$data['sort_date_added'] = $this->url->link('sale/return', 'user_token=' . $this->session->data['user_token'] . '&sort=r.date_added' . $url, true);
		$data['sort_date_modified'] = $this->url->link('sale/return', 'user_token=' . $this->session->data['user_token'] . '&sort=r.date_modified' . $url, true);

		$url = '';

		if (isset($this->request->get['filter_return_id'])) {
			$url .= '&filter_return_id=' . $this->request->get['filter_return_id'];
		}

		if (isset($this->request->get['filter_order_id'])) {
			$url .= '&filter_order_id=' . $this->request->get['filter_order_id'];
		}

		if (isset($this->request->get['filter_customer'])) {
			$url .= '&filter_customer=' . urlencode(html_entity_decode($this->request->get['filter_customer'], ENT_QUOTES, 'UTF-8'));
		}

		if (isset($this->request->get['filter_product'])) {
			$url .= '&filter_product=' . urlencode(html_entity_decode($this->request->get['filter_product'], ENT_QUOTES, 'UTF-8'));
		}

		if (isset($this->request->get['filter_model'])) {
			$url .= '&filter_model=' . urlencode(html_entity_decode($this->request->get['filter_model'], ENT_QUOTES, 'UTF-8'));
		}

		if (isset($this->request->get['filter_return_status_id'])) {
			$url .= '&filter_return_status_id=' . $this->request->get['filter_return_status_id'];
		}

		if (isset($this->request->get['filter_date_added'])) {
			$url .= '&filter_date_added=' . $this->request->get['filter_date_added'];
		}

		if (isset($this->request->get['filter_date_modified'])) {
			$url .= '&filter_date_modified=' . $this->request->get['filter_date_modified'];
		}

		if (isset($this->request->get['sort'])) {
			$url .= '&sort=' . $this->request->get['sort'];
		}

		if (isset($this->request->get['order'])) {
			$url .= '&order=' . $this->request->get['order'];
		}

		$pagination = new Pagination();
		$pagination->total = $return_total;
		$pagination->page = $page;
		$pagination->limit = $this->config->get('config_limit_admin');
		$pagination->url = $this->url->link('sale/return', 'user_token=' . $this->session->data['user_token'] . $url . '&page={page}', true);

		$data['pagination'] = $pagination->render();

		$data['results'] = sprintf($this->language->get('text_pagination'), ($return_total) ? (($page - 1) * $this->config->get('config_limit_admin')) + 1 : 0, ((($page - 1) * $this->config->get('config_limit_admin')) > ($return_total - $this->config->get('config_limit_admin'))) ? $return_total : ((($page - 1) * $this->config->get('config_limit_admin')) + $this->config->get('config_limit_admin')), $return_total, ceil($return_total / $this->config->get('config_limit_admin')));

		$data['filter_return_id'] = $filter_return_id;
		$data['filter_order_id'] = $filter_order_id;
		$data['filter_customer'] = $filter_customer;
		$data['filter_product'] = $filter_product;
		$data['filter_model'] = $filter_model;
		$data['filter_return_status_id'] = $filter_return_status_id;
		$data['filter_date_added'] = $filter_date_added;
		$data['filter_date_modified'] = $filter_date_modified;

		$this->load->model('localisation/return_status');

		$data['return_statuses'] = $this->model_localisation_return_status->getReturnStatuses();

		$data['sort'] = $sort;
		$data['order'] = $order;
		$data['text_confirm_refund_amount'] = $this->language->get('text_confirm_refund_amount');
		$data['text_confirm_refund_amount_same'] = $this->language->get('text_confirm_refund_amount_same');
		$data['text_refund_amount_range'] = $this->language->get('text_refund_amount_range');
		$data['text_refund_fetch_failed'] = $this->language->get('text_refund_fetch_failed');
		$data['text_refund_unknown_error'] = $this->language->get('text_refund_unknown_error');
		$data['text_refund_success'] = $this->language->get('text_refund_success');
		$data['text_refund_failed'] = $this->language->get('error_refund_failed');

		$data['header'] = $this->load->controller('common/header');
		$data['column_left'] = $this->load->controller('common/column_left');
		$data['footer'] = $this->load->controller('common/footer');

		$this->response->setOutput($this->load->view('sale/return_list', $data));
	}

	protected function getForm() {
		$data['text_form'] = !isset($this->request->get['return_id']) ? $this->language->get('text_add') : $this->language->get('text_edit');

		$data['user_token'] = $this->session->data['user_token'];

		if (isset($this->request->get['return_id'])) {
			$data['return_id'] = (int)$this->request->get['return_id'];
		} else {
			$data['return_id'] = 0;
		}

		if (isset($this->error['warning'])) {
			$data['error_warning'] = $this->error['warning'];
		} else {
			$data['error_warning'] = '';
		}

		if (isset($this->error['order_id'])) {
			$data['error_order_id'] = $this->error['order_id'];
		} else {
			$data['error_order_id'] = '';
		}

		if (isset($this->error['firstname'])) {
			$data['error_firstname'] = $this->error['firstname'];
		} else {
			$data['error_firstname'] = '';
		}

		if (isset($this->error['lastname'])) {
			$data['error_lastname'] = $this->error['lastname'];
		} else {
			$data['error_lastname'] = '';
		}

		if (isset($this->error['email'])) {
			$data['error_email'] = $this->error['email'];
		} else {
			$data['error_email'] = '';
		}

		if (isset($this->error['telephone'])) {
			$data['error_telephone'] = $this->error['telephone'];
		} else {
			$data['error_telephone'] = '';
		}

		if (isset($this->error['product'])) {
			$data['error_product'] = $this->error['product'];
		} else {
			$data['error_product'] = '';
		}

		if (isset($this->error['model'])) {
			$data['error_model'] = $this->error['model'];
		} else {
			$data['error_model'] = '';
		}

		$url = '';

		if (isset($this->request->get['filter_return_id'])) {
			$url .= '&filter_return_id=' . $this->request->get['filter_return_id'];
		}

		if (isset($this->request->get['filter_order_id'])) {
			$url .= '&filter_order_id=' . $this->request->get['filter_order_id'];
		}

		if (isset($this->request->get['filter_customer'])) {
			$url .= '&filter_customer=' . urlencode(html_entity_decode($this->request->get['filter_customer'], ENT_QUOTES, 'UTF-8'));
		}

		if (isset($this->request->get['filter_product'])) {
			$url .= '&filter_product=' . urlencode(html_entity_decode($this->request->get['filter_product'], ENT_QUOTES, 'UTF-8'));
		}

		if (isset($this->request->get['filter_model'])) {
			$url .= '&filter_model=' . urlencode(html_entity_decode($this->request->get['filter_model'], ENT_QUOTES, 'UTF-8'));
		}

		if (isset($this->request->get['filter_return_status_id'])) {
			$url .= '&filter_return_status_id=' . $this->request->get['filter_return_status_id'];
		}

		if (isset($this->request->get['filter_date_added'])) {
			$url .= '&filter_date_added=' . $this->request->get['filter_date_added'];
		}

		if (isset($this->request->get['filter_date_modified'])) {
			$url .= '&filter_date_modified=' . $this->request->get['filter_date_modified'];
		}

		if (isset($this->request->get['sort'])) {
			$url .= '&sort=' . $this->request->get['sort'];
		}

		if (isset($this->request->get['order'])) {
			$url .= '&order=' . $this->request->get['order'];
		}

		if (isset($this->request->get['page'])) {
			$url .= '&page=' . $this->request->get['page'];
		}

		$data['breadcrumbs'] = array();

		$data['breadcrumbs'][] = array(
			'text' => $this->language->get('text_home'),
			'href' => $this->url->link('common/dashboard', 'user_token=' . $this->session->data['user_token'], true)
		);

		$data['breadcrumbs'][] = array(
			'text' => $this->language->get('heading_title'),
			'href' => $this->url->link('sale/return', 'user_token=' . $this->session->data['user_token'] . $url, true)
		);

		if (!isset($this->request->get['return_id'])) {
			$data['action'] = $this->url->link('sale/return/add', 'user_token=' . $this->session->data['user_token'] . $url, true);
		} else {
			$data['action'] = $this->url->link('sale/return/edit', 'user_token=' . $this->session->data['user_token'] . '&return_id=' . $this->request->get['return_id'] . $url, true);
		}

		$data['cancel'] = $this->url->link('sale/return', 'user_token=' . $this->session->data['user_token'] . $url, true);

		if (isset($this->request->get['return_id']) && ($this->request->server['REQUEST_METHOD'] != 'POST')) {
			$return_info = $this->model_sale_return->getReturn($this->request->get['return_id']);
		}

		if (isset($this->request->post['order_id'])) {
			$data['order_id'] = $this->request->post['order_id'];
		} elseif (!empty($return_info)) {
			$data['order_id'] = $return_info['order_id'];
		} else {
			$data['order_id'] = '';
		}

		if (isset($this->request->post['date_ordered'])) {
			$data['date_ordered'] = $this->request->post['date_ordered'];
		} elseif (!empty($return_info)) {
			$data['date_ordered'] = ($return_info['date_ordered'] != '0000-00-00' ? $return_info['date_ordered'] : '');
		} else {
			$data['date_ordered'] = '';
		}

		if (isset($this->request->post['customer'])) {
			$data['customer'] = $this->request->post['customer'];
		} elseif (!empty($return_info)) {
			$data['customer'] = $return_info['customer'];
		} else {
			$data['customer'] = '';
		}

		if (isset($this->request->post['customer_id'])) {
			$data['customer_id'] = $this->request->post['customer_id'];
		} elseif (!empty($return_info)) {
			$data['customer_id'] = $return_info['customer_id'];
		} else {
			$data['customer_id'] = '';
		}

		if (isset($this->request->post['firstname'])) {
			$data['firstname'] = $this->request->post['firstname'];
		} elseif (!empty($return_info)) {
			$data['firstname'] = $return_info['firstname'];
		} else {
			$data['firstname'] = '';
		}

		if (isset($this->request->post['lastname'])) {
			$data['lastname'] = $this->request->post['lastname'];
		} elseif (!empty($return_info)) {
			$data['lastname'] = $return_info['lastname'];
		} else {
			$data['lastname'] = '';
		}

		if (isset($this->request->post['email'])) {
			$data['email'] = $this->request->post['email'];
		} elseif (!empty($return_info)) {
			$data['email'] = $return_info['email'];
		} else {
			$data['email'] = '';
		}

		if (isset($this->request->post['telephone'])) {
			$data['telephone'] = $this->request->post['telephone'];
		} elseif (!empty($return_info)) {
			$data['telephone'] = $return_info['telephone'];
		} else {
			$data['telephone'] = '';
		}

		if (isset($this->request->post['product'])) {
			$data['product'] = $this->request->post['product'];
		} elseif (!empty($return_info)) {
			$data['product'] = $return_info['product'];
		} else {
			$data['product'] = '';
		}

		if (isset($this->request->post['product_id'])) {
			$data['product_id'] = $this->request->post['product_id'];
		} elseif (!empty($return_info)) {
			$data['product_id'] = $return_info['product_id'];
		} else {
			$data['product_id'] = '';
		}

		if (isset($this->request->post['model'])) {
			$data['model'] = $this->request->post['model'];
		} elseif (!empty($return_info)) {
			$data['model'] = $return_info['model'];
		} else {
			$data['model'] = '';
		}

		if (isset($this->request->post['quantity'])) {
			$data['quantity'] = $this->request->post['quantity'];
		} elseif (!empty($return_info)) {
			$data['quantity'] = $return_info['quantity'];
		} else {
			$data['quantity'] = '';
		}

		if (isset($this->request->post['opened'])) {
			$data['opened'] = $this->request->post['opened'];
		} elseif (!empty($return_info)) {
			$data['opened'] = $return_info['opened'];
		} else {
			$data['opened'] = '';
		}

		if (isset($this->request->post['return_reason_id'])) {
			$data['return_reason_id'] = $this->request->post['return_reason_id'];
		} elseif (!empty($return_info)) {
			$data['return_reason_id'] = $return_info['return_reason_id'];
		} else {
			$data['return_reason_id'] = '';
		}

		$this->load->model('localisation/return_reason');

		$data['return_reasons'] = $this->model_localisation_return_reason->getReturnReasons();

		if (isset($this->request->post['return_action_id'])) {
			$data['return_action_id'] = $this->request->post['return_action_id'];
		} elseif (!empty($return_info)) {
			$data['return_action_id'] = $return_info['return_action_id'];
		} else {
			$data['return_action_id'] = '';
		}

		$this->load->model('localisation/return_action');

		$data['return_actions'] = $this->model_localisation_return_action->getReturnActions();

		if (isset($this->request->post['comment'])) {
			$data['comment'] = $this->request->post['comment'];
		} elseif (!empty($return_info)) {
			$data['comment'] = $return_info['comment'];
		} else {
			$data['comment'] = '';
		}

		if (isset($this->request->post['return_status_id'])) {
			$data['return_status_id'] = $this->request->post['return_status_id'];
		} elseif (!empty($return_info)) {
			$data['return_status_id'] = $return_info['return_status_id'];
		} else {
			$data['return_status_id'] = '';
		}

		$this->load->model('localisation/return_status');

		$data['return_statuses'] = $this->model_localisation_return_status->getReturnStatuses();

		$data['header'] = $this->load->controller('common/header');
		$data['column_left'] = $this->load->controller('common/column_left');
		$data['footer'] = $this->load->controller('common/footer');

		$this->response->setOutput($this->load->view('sale/return_form', $data));
	}

	protected function validateForm() {
		if (!$this->user->hasPermission('modify', 'sale/return')) {
			$this->error['warning'] = $this->language->get('error_permission');
		}

		if (empty($this->request->post['order_id'])) {
			$this->error['order_id'] = $this->language->get('error_order_id');
		}

		if ((utf8_strlen(trim($this->request->post['firstname'])) < 1) || (utf8_strlen(trim($this->request->post['firstname'])) > 32)) {
			$this->error['firstname'] = $this->language->get('error_firstname');
		}

		if ((utf8_strlen(trim($this->request->post['lastname'])) < 1) || (utf8_strlen(trim($this->request->post['lastname'])) > 32)) {
			$this->error['lastname'] = $this->language->get('error_lastname');
		}

		if ((utf8_strlen($this->request->post['email']) > 96) || !filter_var($this->request->post['email'], FILTER_VALIDATE_EMAIL)) {
			$this->error['email'] = $this->language->get('error_email');
		}

		if ((utf8_strlen($this->request->post['telephone']) < 3) || (utf8_strlen($this->request->post['telephone']) > 32)) {
			$this->error['telephone'] = $this->language->get('error_telephone');
		}

		if ((utf8_strlen($this->request->post['product']) < 1) || (utf8_strlen($this->request->post['product']) > 255)) {
			$this->error['product'] = $this->language->get('error_product');
		}

		if ((utf8_strlen($this->request->post['model']) < 1) || (utf8_strlen($this->request->post['model']) > 64)) {
			$this->error['model'] = $this->language->get('error_model');
		}

		if (empty($this->request->post['return_reason_id'])) {
			$this->error['reason'] = $this->language->get('error_reason');
		}

		if ($this->error && !isset($this->error['warning'])) {
			$this->error['warning'] = $this->language->get('error_warning');
		}

		return !$this->error;
	}

	protected function validateDelete() {
		if (!$this->user->hasPermission('modify', 'sale/return')) {
			$this->error['warning'] = $this->language->get('error_permission');
		}

		return !$this->error;
	}

	public function history() {
		$this->load->language('sale/return');

		$this->load->model('sale/return');

		if (isset($this->request->get['page'])) {
			$page = (int)$this->request->get['page'];
		} else {
			$page = 1;
		}

		$data['histories'] = array();

		$results = $this->model_sale_return->getReturnHistories($this->request->get['return_id'], ($page - 1) * 10, 10);

		foreach ($results as $result) {
			$data['histories'][] = array(
				'notify'     => $result['notify'] ? $this->language->get('text_yes') : $this->language->get('text_no'),
				'status'     => $result['status'],
				'comment'    => nl2br($result['comment']),
				'date_added' => date($this->language->get('date_format_short'), strtotime($result['date_added']))
			);
		}

		$history_total = $this->model_sale_return->getTotalReturnHistories($this->request->get['return_id']);

		$pagination = new Pagination();
		$pagination->total = $history_total;
		$pagination->page = $page;
		$pagination->limit = 10;
		$pagination->url = $this->url->link('sale/return/history', 'user_token=' . $this->session->data['user_token'] . '&return_id=' . $this->request->get['return_id'] . '&page={page}', true);

		$data['pagination'] = $pagination->render();

		$data['results'] = sprintf($this->language->get('text_pagination'), ($history_total) ? (($page - 1) * 10) + 1 : 0, ((($page - 1) * 10) > ($history_total - 10)) ? $history_total : ((($page - 1) * 10) + 10), $history_total, ceil($history_total / 10));

		$this->response->setOutput($this->load->view('sale/return_history', $data));
	}

	public function addHistory() {
		$this->load->language('sale/return');

		$json = array();

		if (!$this->user->hasPermission('modify', 'sale/return')) {
			$json['error'] = $this->language->get('error_permission');
		} else {
			$this->load->model('sale/return');

			$this->model_sale_return->addReturnHistory($this->request->get['return_id'], $this->request->post['return_status_id'], $this->request->post['comment'], $this->request->post['notify']);

			$json['success'] = $this->language->get('text_success');
		}

		$this->response->addHeader('Content-Type: application/json');
		$this->response->setOutput(json_encode($json));
	}

	/**
	 * 退款处理方法
	 * 从退货列表点击退款按钮时调用
	 */
	public function refund() {
		$this->load->language('sale/return');
		$this->load->language('extension/payment/wonderpayment');
		$this->load->model('sale/return');
		$this->load->model('sale/order');
		$this->load->model('extension/payment/wonderpayment');

		$json = array();

		// 检查权限
		if (!$this->user->hasPermission('modify', 'sale/return')) {
			$json['error'] = $this->language->get('error_permission');
			$this->response->addHeader('Content-Type: application/json');
			$this->response->setOutput(json_encode($json));
			return;
		}

		// 获取参数
		if (!isset($this->request->get['return_id']) || !isset($this->request->get['order_id'])) {
			$json['error'] = $this->language->get('error_missing_parameters');
			$this->response->addHeader('Content-Type: application/json');
			$this->response->setOutput(json_encode($json));
			return;
		}

		$return_id = (int)$this->request->get['return_id'];
		$order_id = (int)$this->request->get['order_id'];

		// 获取退货信息
		$return_info = $this->model_sale_return->getReturn($return_id);
		if (!$return_info) {
			$json['error'] = $this->language->get('error_return_not_found');
			$this->response->addHeader('Content-Type: application/json');
			$this->response->setOutput(json_encode($json));
			return;
		}

		// 退货状态不要阻断部分退款，是否可退以可退款金额为准

		// 获取订单信息
		$order_info = $this->model_sale_order->getOrder($order_id);
		if (!$order_info) {
			$json['error'] = $this->language->get('error_order_not_found');
			$this->response->addHeader('Content-Type: application/json');
			$this->response->setOutput(json_encode($json));
			return;
		}

		// 获取支付信息
		$payment_info = $this->model_extension_payment_wonderpayment->getOrderPaymentInfo($order_id);

		// 简单的验证，先不使用日志
		if (!$payment_info || !isset($payment_info['reference_number']) || $payment_info['reference_number'] === '' || $payment_info['reference_number'] === null) {
			// 在创建日志之后，再添加详细的调试信息
			$json['error'] = $this->language->get('error_payment_info_incomplete');
			$this->response->addHeader('Content-Type: application/json');
			$this->response->setOutput(json_encode($json));
			return;
		}

		// 检查支付状态
		if ($payment_info['status'] != 'paid') {
			$json['error'] = $this->language->get('error_order_not_paid');
			$this->response->addHeader('Content-Type: application/json');
			$this->response->setOutput(json_encode($json));
			return;
		}

		// 初始化日志并记录调试信息
		$log = new Log('wonderpayment.log');
		$log->write('=== 开始处理退款请求 ===');
		$log->write('订单ID: ' . $order_id);
		$this->logJson($log, '支付信息: ', $payment_info);

		// 验证订单支付方式是否为WonderPayment
		if ($order_info['payment_code'] !== 'wonderpayment') {
			$log->write('警告: 订单 #' . $order_id . ' 的支付方式不是WonderPayment，支付代码: ' . $order_info['payment_code']);
			$json['error'] = $this->language->get('error_payment_method_not_supported');
			$this->response->addHeader('Content-Type: application/json');
			$this->response->setOutput(json_encode($json));
			return;
		}

		// 检查transaction_uuid，如果为空则尝试通过API查询获取
		$transaction_uuid = $payment_info['transaction_uuid'];
		if (empty($transaction_uuid)) {
			$log->write('警告: 订单 ' . $order_id . ' 的transaction_uuid为空，尝试通过API查询获取');

			// 尝试查询订单以获取transaction_uuid
			try {
				// 初始化WonderPayment SDK用于查询
				$lib_path = DIR_SYSTEM . 'library/wonderpayment.php';
				if (!file_exists($lib_path)) {
					$log->write('错误：WonderPayment 库文件不存在: ' . $lib_path);
				} else {
					require_once $lib_path;

					// 获取配置
					$appid = $this->config->get('payment_wonderpayment_appid');
					$privateKey = $this->config->get('payment_wonderpayment_private_key');
					$publicKey = $this->config->get('payment_wonderpayment_public_key');
					$environment = $this->config->get('payment_wonderpayment_environment') ? $this->config->get('payment_wonderpayment_environment') : 'stg';

					if (!empty($appid) && !empty($privateKey) && !empty($publicKey)) {
						$config = array(
							'appid' => $appid,
							'signaturePrivateKey' => $privateKey,
							'webhookVerifyPublicKey' => $publicKey,
							'callback_url' => '',
							'redirect_url' => '',
							'environment' => $environment
						);

						$wonderpayment_query = new WonderPayment($config, $log);

						// 查询订单信息 - 确保参数不是数组
						$ref_number = is_array($payment_info['reference_number']) ? json_encode($payment_info['reference_number']) : $payment_info['reference_number'];
						$order_number = isset($payment_info['order_number']) && !is_array($payment_info['order_number']) ? $payment_info['order_number'] : null;

						$log->write('开始查询订单，reference_number: ' . $ref_number . ', order_number: ' . ($order_number ?: 'NULL'));

						$order_response = $wonderpayment_query->queryOrder(
							$ref_number,
							$order_number,
							null // 先不使用transaction_uuid，因为我们要获取它
						);
						$this->logJson($log, '订单查询响应: ', $order_response);

						// 检查响应是否成功
						if (isset($order_response['code']) && $order_response['code'] == 200 && isset($order_response['data']['order'])) {
							$order_data = $order_response['data']['order'];

							// 尝试从响应中提取transaction_uuid
							// 优先从transactions数组中获取
							if (isset($order_data['transactions']) && is_array($order_data['transactions']) && !empty($order_data['transactions'])) {
								// 查找已支付的交易
								foreach ($order_data['transactions'] as $transaction) {
									if (isset($transaction['uuid']) && !empty($transaction['uuid'])) {
										$transaction_uuid = $transaction['uuid'];
										$log->write('从transactions数组中获取到transaction_uuid: ' . $transaction_uuid);
										break;
									}
								}
							}

							// 如果仍然没有找到，尝试从其他可能的位置获取
							if (empty($transaction_uuid) && isset($order_data['transaction']) && isset($order_data['transaction']['uuid'])) {
								$transaction_uuid = $order_data['transaction']['uuid'];
								$log->write('从transaction对象中获取到transaction_uuid: ' . $transaction_uuid);
							}

							// 如果找到了transaction_uuid，更新数据库
							if (!empty($transaction_uuid)) {
								$log->write('更新数据库中的transaction_uuid: ' . $transaction_uuid);
								// 安全调用模型方法，避免代理对象问题
								if (isset($this->model_extension_payment_wonderpayment) && method_exists($this->model_extension_payment_wonderpayment, 'updateTransactionUuid')) {
									$this->model_extension_payment_wonderpayment->updateTransactionUuid($order_id, $transaction_uuid);
									$log->write('已将transaction_uuid更新到数据库');
								} else {
									$log->write('警告: 模型或方法不存在，无法更新transaction_uuid');
								}
							} else {
								$log->write('警告: 从API响应中未能获取到有效的transaction_uuid');
							}
						} else {
							$log->write('警告: 订单查询API调用失败或响应格式不正确');
						}
					}
				}
			} catch (Exception $e) {
				$log->write('查询订单获取transaction_uuid时出错: ' . $e->getMessage());
				$log->write('错误详情: ' . $e->getTraceAsString());
			}
		}

		// 确保有有效的transaction_uuid用于退款
		if (empty($transaction_uuid)) {
			$log->write('错误: 无法获取有效的transaction_uuid，无法进行退款操作');
			$this->logJson($log, '支付信息: ', $payment_info);
			$json['error'] = $this->language->get('error_invalid_transaction_uuid');
			$this->response->addHeader('Content-Type: application/json');
			$this->response->setOutput(json_encode($json));
			return;
		}

		// 检查支付状态
		if ($payment_info['status'] != 'paid') {
			$json['error'] = $this->language->get('error_order_not_paid');
			$this->response->addHeader('Content-Type: application/json');
			$this->response->setOutput(json_encode($json));
			return;
		}

		// 检查是否已经全额退款（按基准金额+汇率换算为结算币种）
		$settlement_currency = $order_info['currency_code'];
		$currencyValue = $this->resolveCurrencyValue($order_info);
		$baseCurrency = $this->config->get('config_currency');
		$this->model_extension_payment_wonderpayment->ensureRefundSchema();
		$refunds = $this->model_extension_payment_wonderpayment->getRefundsByOrderId($order_id);
		$total_refunded_base = 0.0;

		foreach ($refunds as $refund) {
			if ($refund['status'] !== 'success') {
				continue;
			}
			if (!empty($refund['original_amount']) && !empty($refund['original_currency']) && $refund['original_currency'] === $baseCurrency) {
				$total_refunded_base += (float)$refund['original_amount'];
				continue;
			}
			if ($refund['refund_currency'] === $baseCurrency) {
				$total_refunded_base += (float)$refund['refund_amount'];
			} elseif ($refund['refund_currency'] === $settlement_currency) {
				$total_refunded_base += (float)$refund['refund_amount'] / $currencyValue;
			} else {
				$total_refunded_base += (float)$refund['refund_amount'];
			}
		}

		$available_refund_base = max(0, (float)$order_info['total'] - $total_refunded_base);
		$available_refund = $available_refund_base * $currencyValue;

		if ($available_refund <= 0) {
			$json['error'] = $this->language->get('error_order_fully_refunded');
			$this->response->addHeader('Content-Type: application/json');
			$this->response->setOutput(json_encode($json));
			return;
		}

		// 注意：日志已在验证后创建

		try {
			// 加载 WonderPayment 库
			$lib_path = DIR_SYSTEM . 'library/wonderpayment.php';
			if (!file_exists($lib_path)) {
				$json['error'] = $this->language->get('error_library_missing');
				$log->write('错误：WonderPayment 库文件不存在');
				$this->response->addHeader('Content-Type: application/json');
				$this->response->setOutput(json_encode($json));
				return;
			}

			require_once $lib_path;

			// 获取配置
			$appid = $this->config->get('payment_wonderpayment_appid');
			$privateKey = $this->config->get('payment_wonderpayment_private_key');
			$publicKey = $this->config->get('payment_wonderpayment_public_key');
			$environment = $this->config->get('payment_wonderpayment_environment') ? $this->config->get('payment_wonderpayment_environment') : 'stg';

			if (empty($appid) || empty($privateKey) || empty($publicKey)) {
				$json['error'] = $this->language->get('error_config_missing');
				$log->write('支付配置错误：缺少必要的配置项');
				$this->response->addHeader('Content-Type: application/json');
				$this->response->setOutput(json_encode($json));
				return;
			}

			// 构建配置
			$config = array(
				'appid' => $appid,
				'signaturePrivateKey' => $privateKey,
				'webhookVerifyPublicKey' => $publicKey,
				'callback_url' => '',
				'redirect_url' => '',
				'environment' => $environment
			);

			// 初始化 WonderPayment
			$wonderpayment = new WonderPayment($config, $log);

			// 检查是否提供了自定义退款金额（用于部分退款）
			$refundAmount = $available_refund; // 默认全额退款
			if (isset($this->request->post['refund_amount']) && is_numeric($this->request->post['refund_amount'])) {
				$customRefundAmount = (float)$this->request->post['refund_amount'];
				// 验证自定义退款金额是否在有效范围内
				if ($customRefundAmount > 0 && $customRefundAmount <= $available_refund) {
					$refundAmount = $customRefundAmount;
				} else {
					$json['error'] = $this->language->get('error_refund_amount_exceeded') . ': ' . $this->language->get('text_max_refund_amount') . ' ' . $this->currency->format($available_refund, $settlement_currency, 1, true);
					$this->response->addHeader('Content-Type: application/json');
					$this->response->setOutput(json_encode($json));
					return;
				}
			}

			$refundAmountSettlement = $refundAmount;
			$refundAmountBase = $currencyValue > 0 ? ($refundAmountSettlement / $currencyValue) : $refundAmountSettlement;
			$log->write('=== 准备调用退款接口 ===');
			$log->write('退款金额: ' . $refundAmount . ' (可退金额: ' . $available_refund . ')，' . $settlement_currency . ': ' . $refundAmountSettlement);
			$log->write('退款订单参考号: ' . $payment_info['reference_number']);
			$log->write('退款交易UUID: ' . ($transaction_uuid ?: 'NULL'));

			// 记录完整的退款请求参数
			$requestParams = array(
				'order' => array(
					'reference_number' => $payment_info['reference_number']
				),
				'transaction' => array(
					'uuid' => $transaction_uuid ?: ''
				),
				'refund' => array(
					'amount' => $refundAmountSettlement
				)
			);
			$this->logJson($log, '退款请求参数: ', $requestParams);

			// 检查transaction_uuid是否为空
			if (empty($transaction_uuid)) {
				$log->write('错误: transaction_uuid为空，无法进行退款操作');
				$json['error'] = $this->language->get('error_transaction_uuid_empty');
				$this->response->addHeader('Content-Type: application/json');
				$this->response->setOutput(json_encode($json));
				return;
			}

			// 准备退款备注
			$refundNote = 'OpenCart退款 - 订单ID: ' . $order_id . ', 退货ID: ' . $return_id;

			// 调用退款接口
			$response = $wonderpayment->refundTransaction(
				$payment_info['reference_number'],
				$transaction_uuid,
				$refundAmountSettlement,
				isset($payment_info['order_number']) ? $payment_info['order_number'] : null, // order_number
				$refundNote // refund note
			);

			$this->logJson($log, '退款响应: ', $response);

			// 检查退款结果
			if (isset($response['code']) && $response['code'] == 200) {
				// 退款成功，记录退款信息
				$log->write('=== 退款成功 ===');
				$log->write('响应代码: ' . $response['code']);
				$this->logJson($log, '完整响应: ', $response);

				// 开始数据库事务
				$this->db->query("START TRANSACTION");

				try {
					$response['original_amount'] = $refundAmountBase;
					$response['original_currency'] = $baseCurrency;
					$response['settlement_amount'] = $refundAmountSettlement;
					$response['settlement_currency'] = $settlement_currency;

					$refund_data = array(
						'order_id' => $order_id,
						'reference_number' => $payment_info['reference_number'],
						'transaction_uuid' => $transaction_uuid,
						'refund_amount' => $refundAmountSettlement,
						'refund_currency' => $settlement_currency,
						'refund_data' => json_encode($response),
						'status' => 'success',
						'date_added' => date('Y-m-d H:i:s')
					);

					// 构建插入字段
					$insert_fields = array(
						"order_id = '" . (int)$refund_data['order_id'] . "'",
						"reference_number = '" . $this->db->escape($refund_data['reference_number']) . "'",
						"refund_amount = '" . (float)$refund_data['refund_amount'] . "'",
						"refund_currency = '" . $this->db->escape($refund_data['refund_currency']) . "'",
						"original_amount = '" . (float)$refundAmountBase . "'",
						"original_currency = '" . $this->db->escape($baseCurrency) . "'",
						"refund_data = '" . $this->db->escape($refund_data['refund_data']) . "'",
						"status = '" . $this->db->escape($refund_data['status']) . "'",
						"date_added = '" . $refund_data['date_added'] . "'"
					);

					// 只有当transaction_uuid不为空时才添加
					if (!empty($refund_data['transaction_uuid'])) {
						$insert_fields[] = "transaction_uuid = '" . $this->db->escape($refund_data['transaction_uuid']) . "'";
					}

					$this->db->query("INSERT INTO " . DB_PREFIX . "wonderpayment_refund SET " . implode(', ', $insert_fields));

					$final_refund_base = $total_refunded_base + $refundAmountBase;
					if ($final_refund_base >= (float)$order_info['total']) {
						// 全额退款才更新订单/退货状态为已退款
						$refunded_status_id = $this->getRefundedStatusId();
						if ($refunded_status_id) {
							$this->db->query("UPDATE " . DB_PREFIX . "order SET order_status_id = '" . (int)$refunded_status_id . "' WHERE order_id = '" . (int)$order_id . "'");
							$log->write('OpenCart订单状态已更新为已退款 (状态ID: ' . $refunded_status_id . ')');

							// 添加订单历史记录
							$this->db->query("INSERT INTO " . DB_PREFIX . "order_history SET order_id = '" . (int)$order_id . "', order_status_id = '" . (int)$refunded_status_id . "', notify = '0', comment = '" . $this->language->get('text_refund_success') . "，退款金额: " . $this->db->escape($this->currency->format($refundAmount, $settlement_currency, 1, true)) . " (" . $this->db->escape($this->currency->format($refundAmountSettlement, $settlement_currency, 1, true)) . ")', date_added = NOW()");
						} else {
							$log->write('警告: 未找到"Refunded"订单状态，无法更新订单状态');
						}

						$return_refunded_status_id = $this->getReturnRefundedStatusId();
						if ($return_refunded_status_id) {
							$refunded_action_id = 1; // "Refunded" action ID
							$this->db->query("UPDATE " . DB_PREFIX . "return SET return_action_id = '" . (int)$refunded_action_id . "', return_status_id = '" . (int)$return_refunded_status_id . "', date_modified = NOW() WHERE return_id = '" . (int)$return_id . "'");
							$log->write('退货记录状态已更新为已退款 (状态ID: ' . $return_refunded_status_id . ')，操作已更新为Refunded (操作ID: ' . $refunded_action_id . ')');

							// 添加退货历史记录
							$this->db->query("INSERT INTO " . DB_PREFIX . "return_history SET return_id = '" . (int)$return_id . "', return_status_id = '" . (int)$return_refunded_status_id . "', notify = '0', comment = '" . $this->language->get('text_refund_success') . "，退款金额: " . $this->db->escape($this->currency->format($refundAmount, $settlement_currency, 1, true)) . " (" . $this->db->escape($this->currency->format($refundAmountSettlement, $settlement_currency, 1, true)) . ")', date_added = NOW()");
						} else {
							$refunded_action_id = 1; // "Refunded" action ID
							$this->db->query("UPDATE " . DB_PREFIX . "return SET return_action_id = '" . (int)$refunded_action_id . "', date_modified = NOW() WHERE return_id = '" . (int)$return_id . "'");
							$log->write('警告: 未找到退货"已退款"状态，仅更新操作为Refunded (操作ID: ' . $refunded_action_id . ')');
						}
					}

					// 提交事务
					$this->db->query("COMMIT");

					$json['success'] = $this->language->get('text_refund_success') . '！' . $this->language->get('text_refund_amount') . ': ' . $this->currency->format($refundAmount, $settlement_currency, 1, true) . ' (' . $this->currency->format($refundAmountSettlement, $settlement_currency, 1, true) . ')';
					$log->write('退款记录已保存到数据库');

				} catch (Exception $e) {
					// 回滚事务
					$this->db->query("ROLLBACK");
					$log->write('退款数据库操作失败，已回滚事务: ' . $e->getMessage());
					throw $e;
				}
			} else {
				$log->write('=== 退款失败 ===');
				$log->write('响应代码: ' . (isset($response['code']) ? $response['code'] : 'N/A'));
				$log->write('响应消息: ' . (isset($response['message']) ? $response['message'] : 'N/A'));
				$this->logJson($log, '完整响应: ', $response);
				$json['error'] = $this->language->get('error_refund_failed') . ': ' . (isset($response['message']) ? $response['message'] : $this->language->get('error_unknown') . '，' . $this->language->get('text_response_code') . ': ' . (isset($response['code']) ? $response['code'] : 'N/A'));
			}

		} catch (Exception $e) {
			$log->write('=== 退款异常 ===');
			$log->write('异常类型: ' . get_class($e));
			$log->write('异常消息: ' . $e->getMessage());
			$log->write('异常文件: ' . $e->getFile());
			$log->write('异常行号: ' . $e->getLine());
			$log->write('异常堆栈: ' . $e->getTraceAsString());
			$json['error'] = $this->language->get('error_refund_exception') . ': ' . $e->getMessage();
		}

		$this->response->addHeader('Content-Type: application/json');
		$this->response->setOutput(json_encode($json));
	}

	/**
	 * 获取退款状态ID
	 * OpenCart内置的Refunded状态ID为11
	 */
	private function getRefundedStatusId() {
		// 首先尝试查找OpenCart内置的Refunded状态ID 11
		$query = $this->db->query("SELECT order_status_id FROM " . DB_PREFIX . "order_status WHERE order_status_id = 11 AND name = 'Refunded'");

		if ($query->num_rows) {
			return $query->row['order_status_id'];
		}

		// 如果ID 11不是Refunded状态，则通过名称查找
		$query = $this->db->query("SELECT order_status_id FROM " . DB_PREFIX . "order_status WHERE name = 'Refunded' LIMIT 1");

		if ($query->num_rows) {
			return $query->row['order_status_id'];
		}

		// 备选方案：查找包含refund的其他状态
		$query = $this->db->query("SELECT order_status_id FROM " . DB_PREFIX . "order_status WHERE LOWER(name) LIKE '%refund%' OR LOWER(name) LIKE '%已退款%' LIMIT 1");

		if ($query->num_rows) {
			return $query->row['order_status_id'];
		}

		// 如果还是找不到，尝试创建新的退款状态
		$language_id = $this->config->get('config_language_id');
		if (!$language_id) {
			$language_id = 1; // 默认语言ID
		}

		$this->db->query("INSERT INTO " . DB_PREFIX . "order_status (name, language_id) VALUES ('Refunded', '" . (int)$language_id . "')");

		$refunded_status_id = $this->db->getLastId();
		if ($refunded_status_id) {
			return $refunded_status_id;
		} else {
			// 最后的备选方案，使用ID为7（通常是已取消状态的默认ID）
			return 7; // OpenCart默认的已取消状态ID
		}
	}

	/**
	 * 获取退货退款状态ID
	 * 如果不存在"已退款"状态，则尝试查找类似的退货状态
	 */
	private function getReturnRefundedStatusId() {
		// 首先尝试查找"Refunded"退货状态
		$query = $this->db->query("SELECT return_status_id FROM " . DB_PREFIX . "return_status WHERE LOWER(name) LIKE '%refund%' OR LOWER(name) LIKE '%已退款%' OR name = 'Refunded' OR name = 'Refund Processed' LIMIT 1");

		if ($query->num_rows) {
			return $query->row['return_status_id'];
		}

		// 如果没有找到退款专用状态，查找其他可能的状态
		$statuses = array('Completed', 'Complete', '已完成', 'Processed', '处理完成');
		foreach ($statuses as $status) {
			$query = $this->db->query("SELECT return_status_id FROM " . DB_PREFIX . "return_status WHERE name = '" . $this->db->escape($status) . "' LIMIT 1");
			if ($query->num_rows) {
				return $query->row['return_status_id'];
			}
		}

		// 尝试插入新的退货退款状态
		$language_id = $this->config->get('config_language_id');
		if (!$language_id) {
			$language_id = 1; // 默认语言ID
		}

		$this->db->query("INSERT INTO " . DB_PREFIX . "return_status (name, language_id) VALUES ('Refunded', '" . (int)$language_id . "')");

		$refunded_status_id = $this->db->getLastId();
		if ($refunded_status_id) {
			return $refunded_status_id;
		} else {
			// 如果插入失败，查找已存在的状态（可能ID已存在）
			$query = $this->db->query("SELECT return_status_id FROM " . DB_PREFIX . "return_status WHERE name = 'Refunded' AND language_id = '" . (int)$language_id . "' LIMIT 1");
			if ($query->num_rows) {
				return $query->row['return_status_id'];
			} else {
				// 最后的备选方案，使用ID为3（通常是Complete状态）
				return 3; // OpenCart默认的Complete退货状态ID
			}
		}
	}

	/**
	 * 获取订单信息（用于退款对话框）
	 * 返回订单总额和可退金额
	 */
	public function getOrderInfo() {
		$this->load->language('sale/return');
		$this->load->language('extension/payment/wonderpayment');
		$this->load->model('sale/order');
		$this->load->model('extension/payment/wonderpayment');

		$json = array();

		if (isset($this->request->post['order_id'])) {
			$order_id = (int)$this->request->post['order_id'];

			// 获取订单信息
			$order_info = $this->model_sale_order->getOrder($order_id);

			if ($order_info) {
				// 检查订单是否使用WonderPayment支付
				if ($order_info['payment_code'] === 'wonderpayment') {
					$this->model_extension_payment_wonderpayment->ensureRefundSchema();
					$settlement_currency = $order_info['currency_code'];
					$currencyValue = $this->resolveCurrencyValue($order_info);
					$baseCurrency = $this->config->get('config_currency');
					$total_refunded_base = 0.0;

					$refunds = $this->model_extension_payment_wonderpayment->getRefundsByOrderId($order_id);
					foreach ($refunds as $refund) {
						if ($refund['status'] !== 'success') {
							continue;
						}
						if (!empty($refund['original_amount']) && !empty($refund['original_currency']) && $refund['original_currency'] === $baseCurrency) {
							$total_refunded_base += (float)$refund['original_amount'];
							continue;
						}
						if ($refund['refund_currency'] === $baseCurrency) {
							$total_refunded_base += (float)$refund['refund_amount'];
						} elseif ($refund['refund_currency'] === $settlement_currency) {
							$total_refunded_base += (float)$refund['refund_amount'] / $currencyValue;
						} else {
							$total_refunded_base += (float)$refund['refund_amount'];
						}
					}

					$available_refund_base = max(0, (float)$order_info['total'] - $total_refunded_base);
					$available_refund = $available_refund_base * $currencyValue;
					$order_total = (float)$order_info['total'] * $currencyValue;
					$total_refunded = $total_refunded_base * $currencyValue;

					$json['success'] = true;
					$json['order_total'] = $order_total;
					$json['total_refunded'] = $total_refunded;
					$json['available_refund'] = $available_refund;
					$json['currency_code'] = $order_info['currency_code'];
					$json['settlement_currency'] = $settlement_currency;
					$json['refund_rate'] = $currencyValue;
				} else {
					$json['error'] = $this->language->get('error_payment_method_not_supported');
				}
			} else {
				$json['error'] = $this->language->get('error_order_not_found');
			}
		} else {
			$json['error'] = $this->language->get('error_order_id');
		}

		$this->response->addHeader('Content-Type: application/json');
		$this->response->setOutput(json_encode($json));
	}

	private function resolveCurrencyValue($order_info) {
		$baseCurrency = $this->config->get('config_currency');
		$currencyValue = (float)$order_info['currency_value'];
		if ($currencyValue <= 0) {
			$currencyValue = 1.0;
		}

		if ($currencyValue == 1.0 && $order_info['currency_code'] !== $baseCurrency) {
			$rate = (float)$this->currency->getValue($order_info['currency_code']);
			if ($rate > 0) {
				$order_product = $this->db->query("SELECT product_id, price FROM " . DB_PREFIX . "order_product WHERE order_id = '" . (int)$order_info['order_id'] . "' LIMIT 1");
				if ($order_product->num_rows) {
					$product = $this->db->query("SELECT price FROM " . DB_PREFIX . "product WHERE product_id = '" . (int)$order_product->row['product_id'] . "' LIMIT 1");
					if ($product->num_rows) {
						$order_price = (float)$order_product->row['price'];
						$base_price = (float)$product->row['price'];

						if ($base_price > 0) {
							$ratio = $order_price / $base_price;
							if ($ratio > 0.8 && $ratio < 1.2) {
								return $rate;
							}

							$converted = $base_price * $rate;
							if ($converted > 0) {
								$ratio_converted = $order_price / $converted;
								if ($ratio_converted > 0.8 && $ratio_converted < 1.2) {
									return 1.0;
								}
							}
						}
					}
				}
			}
		}

		return $currencyValue;
	}

	protected function logJson($log, $prefix, $data) {
		$log->write($prefix . json_encode($this->sanitizeLogData($data), JSON_UNESCAPED_UNICODE));
	}

	protected function sanitizeLogData($data) {
		$sensitive_keys = array(
			'email',
			'phone',
			'telephone',
			'address',
			'firstname',
			'lastname',
			'first_name',
			'last_name',
			'name',
			'token',
			'key',
			'private_key',
			'public_key'
		);

		if (is_array($data)) {
			$clean = array();
			foreach ($data as $key => $value) {
				if (is_string($key) && in_array(strtolower($key), $sensitive_keys, true)) {
					$clean[$key] = '***';
				} else {
					$clean[$key] = $this->sanitizeLogData($value);
				}
			}
			return $clean;
		}

		return $data;
	}

}
]]></add>
    </operation>
  </file>
  <file path="admin/view/template/sale/return_list.twig">
    <operation>
      <search><![CDATA[{ header }]]></search>
      <add position="replace"><![CDATA[{{ header }}{{ column_left }}
<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <div class="pull-right">
        <button type="button" data-toggle="tooltip" title="{{ button_filter }}" onclick="$('#filter-return').toggleClass('hidden-sm hidden-xs');" class="btn btn-default hidden-md hidden-lg"><i class="fa fa-filter"></i></button>
        <a href="{{ add }}" data-toggle="tooltip" title="{{ button_add }}" class="btn btn-primary"><i class="fa fa-plus"></i></a>
        <button type="button" data-toggle="tooltip" title="{{ button_delete }}" class="btn btn-danger" onclick="confirm('{{ text_confirm }}') ? $('#form-return').submit() : false;"><i class="fa fa-trash-o"></i></button>
      </div>
      <h1>{{ heading_title }}</h1>
      <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
        <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>
  <div class="container-fluid">{% if error_warning %}
    <div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}
      <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
    {% endif %}
    {% if success %}
    <div class="alert alert-success alert-dismissible"><i class="fa fa-check-circle"></i> {{ success }}
      <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
    {% endif %}
    <div class="row">
      <div id="filter-return" class="col-md-3 col-md-push-9 col-sm-12 hidden-sm hidden-xs">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title"><i class="fa fa-filter"></i> {{ text_filter }}</h3>
          </div>
          <div class="panel-body">
            <div class="form-group">
              <label class="control-label" for="input-return-id">{{ entry_return_id }}</label>
              <input type="text" name="filter_return_id" value="{{ filter_return_id }}" placeholder="{{ entry_return_id }}" id="input-return-id" class="form-control" />
            </div>
            <div class="form-group">
              <label class="control-label" for="input-order-id">{{ entry_order_id }}</label>
              <input type="text" name="filter_order_id" value="{{ filter_order_id }}" placeholder="{{ entry_order_id }}" id="input-order-id" class="form-control" />
            </div>
            <div class="form-group">
              <label class="control-label" for="input-customer">{{ entry_customer }}</label>
              <input type="text" name="filter_customer" value="{{ filter_customer }}" placeholder="{{ entry_customer }}" id="input-customer" class="form-control" />
            </div>
            <div class="form-group">
              <label class="control-label" for="input-product">{{ entry_product }}</label>
              <input type="text" name="filter_product" value="{{ filter_product }}" placeholder="{{ entry_product }}" id="input-product" class="form-control" />
            </div>
            <div class="form-group">
              <label class="control-label" for="input-model">{{ entry_model }}</label>
              <input type="text" name="filter_model" value="{{ filter_model }}" placeholder="{{ entry_model }}" id="input-model" class="form-control" />
            </div>
            <div class="form-group">
              <label class="control-label" for="input-return-status">{{ entry_return_status }}</label>
              <select name="filter_return_status_id" id="input-return-status" class="form-control">
                <option value=""></option>
                  {% for return_status in return_statuses %}
                  {% if return_status.return_status_id == filter_return_status_id %}
                  <option value="{{ return_status.return_status_id }}" selected="selected">{% if return_status.name == '已退款' %}Refunded{% else %}{{ return_status.name }}{% endif %}</option>
                  {% else %}
                  <option value="{{ return_status.return_status_id }}">{% if return_status.name == '已退款' %}Refunded{% else %}{{ return_status.name }}{% endif %}</option>
                  {% endif %}
                  {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label class="control-label" for="input-date-added">{{ entry_date_added }}</label>
              <div class="input-group date">
                <input type="text" name="filter_date_added" value="{{ filter_date_added }}" placeholder="{{ entry_date_added }}" data-date-format="YYYY-MM-DD" id="input-date-added" class="form-control" />
                <span class="input-group-btn">
                <button type="button" class="btn btn-default"><i class="fa fa-calendar"></i></button>
                </span></div>
            </div>
            <div class="form-group">
              <label class="control-label" for="input-date-modified">{{ entry_date_modified }}</label>
              <div class="input-group date">
                <input type="text" name="filter_date_modified" value="{{ filter_date_modified }}" placeholder="{{ entry_date_modified }}" data-date-format="YYYY-MM-DD" id="input-date-modified" class="form-control" />
                <span class="input-group-btn">
                <button type="button" class="btn btn-default"><i class="fa fa-calendar"></i></button>
                </span></div>
            </div>
            <div class="form-group text-right">
              <button type="button" id="button-filter" class="btn btn-default"><i class="fa fa-filter"></i> {{ button_filter }}</button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-9 col-md-pull-3 col-sm-12">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title"><i class="fa fa-list"></i> {{ text_list }}</h3>
          </div>
          <div class="panel-body">
            <form action="{{ delete }}" method="post" enctype="multipart/form-data" id="form-return">
              <div class="table-responsive">
                <table class="table table-bordered table-hover">
                  <thead>
                    <tr>
                      <td style="width: 1px;" class="text-center"><input type="checkbox" onclick="$('input[name*=\'selected\']').prop('checked', this.checked);" /></td>
                      <td class="text-right">{% if sort == 'r.return_id' %} <a href="{{ sort_return_id }}" class="{{ order|lower }}">{{ column_return_id }}</a> {% else %} <a href="{{ sort_return_id }}">{{ column_return_id }}</a> {% endif %}</td>
                      <td class="text-right">{% if sort == 'r.order_id' %} <a href="{{ sort_order_id }}" class="{{ order|lower }}">{{ column_order_id }}</a> {% else %} <a href="{{ sort_order_id }}">{{ column_order_id }}</a> {% endif %}</td>
                      <td class="text-left">{% if sort == 'customer' %} <a href="{{ sort_customer }}" class="{{ order|lower }}">{{ column_customer }}</a> {% else %} <a href="{{ sort_customer }}">{{ column_customer }}</a> {% endif %}</td>
                      <td class="text-left">{% if sort == 'r.product' %} <a href="{{ sort_product }}" class="{{ order|lower }}">{{ column_product }}</a> {% else %} <a href="{{ sort_product }}">{{ column_product }}</a> {% endif %}</td>
                      <td class="text-left">{% if sort == 'r.model' %} <a href="{{ sort_model }}" class="{{ order|lower }}">{{ column_model }}</a> {% else %} <a href="{{ sort_model }}">{{ column_model }}</a> {% endif %}</td>
                      <td class="text-left">{% if sort == 'status' %} <a href="{{ sort_status }}" class="{{ order|lower }}">{{ column_status }}</a> {% else %} <a href="{{ sort_status }}">{{ column_status }}</a> {% endif %}</td>
                      <td class="text-left">{% if sort == 'r.date_added' %} <a href="{{ sort_date_added }}" class="{{ order|lower }}">{{ column_date_added }}</a> {% else %} <a href="{{ sort_date_added }}">{{ column_date_added }}</a> {% endif %}</td>
                      <td class="text-left">{% if sort == 'r.date_modified' %} <a href="{{ sort_date_modified }}" class="{{ order|lower }}">{{ column_date_modified }}</a> {% else %} <a href="{{ sort_date_modified }}">{{ column_date_modified }}</a> {% endif %}</td>
                      <td class="text-right">{{ column_action }}</td>
                    </tr>
                  </thead>
                  <tbody>

                  {% if returns %}
                  {% for return in returns %}
                  <tr>
                    <td class="text-center">{% if return.return_id in selected %}
                      <input type="checkbox" name="selected[]" value="{{ return.return_id }}" checked="checked" />
                      {% else %}
                      <input type="checkbox" name="selected[]" value="{{ return.return_id }}" />
                      {% endif %}</td>
                    <td class="text-right">{{ return.return_id }}</td>
                    <td class="text-right">{{ return.order_id }}</td>
                    <td class="text-left">{{ return.customer }}</td>
                    <td class="text-left">{{ return.product }}</td>
                    <td class="text-left">{{ return.model }}</td>
                    <td class="text-left">{% if return.return_status == '已退款' %}Refunded{% else %}{{ return.return_status }}{% endif %}</td>
                    <td class="text-left">{{ return.date_added }}</td>
                    <td class="text-left">{{ return.date_modified }}</td>
                    <td class="text-right">
                      <a href="{{ return.edit }}" data-toggle="tooltip" title="{{ button_edit }}" class="btn btn-primary"><i class="fa fa-pencil"></i></a>
                      {% if return.return_action_id != 1 and return.return_status_id != 3 and return.return_status != 'Refunded' and return.return_status != 'Refund Processed' %}
                      <button type="button" data-toggle="tooltip" title="退款" class="btn btn-warning" onclick="showRefundModal({{ return.return_id }}, {{ return.order_id }}, '{{ return.refund }}');"><i class="fa fa-undo"></i></button>
                      {% else %}
                      <span data-toggle="tooltip" title="Refunded" class="btn btn-default disabled"><i class="fa fa-undo"></i></span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                  {% else %}
                  <tr>
                    <td class="text-center" colspan="10">{{ text_no_results }}</td>
                  </tr>
                  {% endif %}
                    </tbody>

                </table>
              </div>
            </form>
            <div class="row">
              <div class="col-sm-6 text-left">{{ pagination }}</div>
              <div class="col-sm-6 text-right">{{ results }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript"><!--
$('#button-filter').on('click', function() {
	url = 'index.php?route=sale/return&user_token={{ user_token }}';

	var filter_return_id = $('input[name=\'filter_return_id\']').val();

	if (filter_return_id) {
		url += '&filter_return_id=' + encodeURIComponent(filter_return_id);
	}

	var filter_order_id = $('input[name=\'filter_order_id\']').val();

	if (filter_order_id) {
		url += '&filter_order_id=' + encodeURIComponent(filter_order_id);
	}	

	var filter_customer = $('input[name=\'filter_customer\']').val();

	if (filter_customer) {
		url += '&filter_customer=' + encodeURIComponent(filter_customer);
	}

	var filter_product = $('input[name=\'filter_product\']').val();

	if (filter_product) {
		url += '&filter_product=' + encodeURIComponent(filter_product);
	}

	var filter_model = $('input[name=\'filter_model\']').val();

	if (filter_model) {
		url += '&filter_model=' + encodeURIComponent(filter_model);
	}

	var filter_return_status_id = $('select[name=\'filter_return_status_id\']').val();

	if (filter_return_status_id !== '') {
		url += '&filter_return_status_id=' + encodeURIComponent(filter_return_status_id);
	}	

	var filter_date_added = $('input[name=\'filter_date_added\']').val();

	if (filter_date_added) {
		url += '&filter_date_added=' + encodeURIComponent(filter_date_added);
	}

	var filter_date_modified = $('input[name=\'filter_date_modified\']').val();

	if (filter_date_modified) {
		url += '&filter_date_modified=' + encodeURIComponent(filter_date_modified);
	}

	location = url;
});
//--></script> 
  <script type="text/javascript"><!--
$('input[name=\'filter_customer\']').autocomplete({
	'source': function(request, response) {
		$.ajax({
			url: 'index.php?route=customer/customer/autocomplete&user_token={{ user_token }}&filter_name=' +  encodeURIComponent(request),
			dataType: 'json',			
			success: function(json) {
				response($.map(json, function(item) {
					return {
						label: item['name'],
						value: item['customer_id']
					}
				}));
			}
		});
	},
	'select': function(item) {
		$('input[name=\'filter_customer\']').val(item['label']);
	}	
});

$('input[name=\'filter_product\']').autocomplete({
	'source': function(request, response) {
		$.ajax({
			url: 'index.php?route=catalog/product/autocomplete&user_token={{ user_token }}&filter_name=' +  encodeURIComponent(request),
			dataType: 'json',			
			success: function(json) {
				response($.map(json, function(item) {
					return {
						label: item['name'],
						value: item['product_id']
					}
				}));
			}
		});
	},
	'select': function(item) {
		$('input[name=\'filter_product\']').val(item['label']);
	}	
});

$('input[name=\'filter_model\']').autocomplete({
	'source': function(request, response) {
		$.ajax({
			url: 'index.php?route=catalog/product/autocomplete&user_token={{ user_token }}&filter_model=' +  encodeURIComponent(request),
			dataType: 'json',			
			success: function(json) {
				response($.map(json, function(item) {
					return {
						label: item['model'],
						value: item['product_id']
					}
				}));
			}
		});
	},
	'select': function(item) {
		$('input[name=\'filter_model\']').val(item['label']);
	}	
});
//--></script> 
  <script type="text/javascript"><!--
$('.date').datetimepicker({
	language: '{{ datepicker }}',
	pickTime: false
});
//--></script>

<!-- 退款模态对话框 -->
<div class="modal fade" id="refund-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title"><i class="fa fa-undo"></i> 退款操作</h4>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="control-label">退款类型</label>
          <div class="radio">
            <label>
              <input type="radio" name="refund_type" value="full" checked="checked" id="refund-type-full"/>
              全额退款
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="refund_type" value="partial" id="refund-type-partial"/>
              部分退款
            </label>
          </div>
        </div>

        <div class="form-group" id="partial-amount-group" style="display: none;">
          <label class="control-label" for="input-refund-amount">退款金额</label>
          <div class="input-group">
            <input type="number" id="input-refund-amount" name="refund_amount" value="0.00" step="0.01" min="0.01" class="form-control"/>
            <span class="input-group-addon" id="refund-currency-code">HKD</span>
          </div>
          <p class="help-block">最大可退金额: <span id="max-refund-amount">0.00</span> <span id="max-refund-currency">HKD</span></p>
        </div>

        <div class="alert alert-info">
          <i class="fa fa-info-circle"></i> 退款操作将直接调用 WonderPayment API，请确认退款信息无误后再提交。
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="button" id="button-confirm-refund" class="btn btn-primary"><i class="fa fa-check"></i> 确认退款</button>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
var currentReturnId = 0;
var currentOrderId = 0;
var currentRefundUrl = '';
var maxRefundAmount = 0;
var refundCurrency = 'HKD';
var settlementCurrency = 'HKD';
var refundRate = 1;
var confirmTextDiff = '{{ text_confirm_refund_amount|e('js') }}';
var confirmTextSame = '{{ text_confirm_refund_amount_same|e('js') }}';
var refundRangeText = '{{ text_refund_amount_range|e('js') }}';

function formatConfirmText(template, amount, currency, settlementAmount, settlementCurrency) {
    return template
        .replace('{amount}', amount)
        .replace('{currency}', currency)
        .replace('{wonder_amount}', settlementAmount)
        .replace('{wonder_currency}', settlementCurrency);
}

// 显示退款模态对话框
function showRefundModal(return_id, order_id, refund_url) {
    currentReturnId = return_id;
    currentOrderId = order_id;
    currentRefundUrl = refund_url;

    // 重置表单
    $('input[name="refund_type"][value="full"]').prop('checked', true);
    $('#partial-amount-group').hide();
    $('#input-refund-amount').val('0.00');

    // 获取订单信息以确定最大可退金额
    $.ajax({
        url: 'index.php?route=sale/return/getOrderInfo&user_token={{ user_token }}',
        type: 'post',
        dataType: 'json',
        data: 'order_id=' + order_id,
        success: function(json) {
            if (json['success']) {
                maxRefundAmount = json['available_refund'];
                refundCurrency = json['currency_code'] || 'HKD';
                settlementCurrency = json['settlement_currency'] || 'HKD';
                refundRate = json['refund_rate'] || 1;
                $('#max-refund-amount').text(maxRefundAmount.toFixed(2));
                $('#input-refund-amount').attr('max', maxRefundAmount);
                $('#input-refund-amount').val(maxRefundAmount.toFixed(2));
                $('#refund-currency-code').text(refundCurrency);
                $('#max-refund-currency').text(refundCurrency);

                // 显示模态对话框
                $('#refund-modal').modal('show');
            } else {
                alert(json['error'] || '{{ text_refund_fetch_failed|e('js') }}');
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert('{{ text_refund_fetch_failed|e('js') }}: ' + thrownError);
        }
    });
}

// 处理退款类型选择
$('input[name="refund_type"]').on('change', function() {
    if ($(this).val() === 'partial') {
        $('#partial-amount-group').show();
    } else {
        $('#partial-amount-group').hide();
        $('#input-refund-amount').val(maxRefundAmount.toFixed(2));
    }
});

// 确认退款
$('#button-confirm-refund').on('click', function() {
    var refundType = $('input[name="refund_type"]:checked').val();
    var refundAmount = 0;

    if (refundType === 'full') {
        refundAmount = maxRefundAmount;
    } else {
        refundAmount = parseFloat($('#input-refund-amount').val());
    }

    // 验证退款金额
    if (refundAmount <= 0 || refundAmount > maxRefundAmount) {
        alert(refundRangeText.replace('{min}', '0.01').replace('{max}', maxRefundAmount.toFixed(2)).replace('{currency}', refundCurrency));
        return false;
    }

    // 确认退款
    var refundAmountHkd = refundAmount * refundRate;
    var confirmMessage = refundCurrency === settlementCurrency
        ? formatConfirmText(confirmTextSame, refundAmount.toFixed(2), refundCurrency, refundAmount.toFixed(2), settlementCurrency)
        : formatConfirmText(confirmTextDiff, refundAmount.toFixed(2), refundCurrency, refundAmountHkd.toFixed(2), settlementCurrency);
    if (!confirm(confirmMessage)) {
        return false;
    }

    // 发起退款请求
    $.ajax({
        url: currentRefundUrl,
        type: 'post',
        dataType: 'json',
        data: 'refund_amount=' + refundAmount,
        beforeSend: function() {
            $('#button-confirm-refund').button('loading');
        },
        complete: function() {
            $('#button-confirm-refund').button('reset');
        },
        success: function(json) {
            if (json['error']) {
                alert('{{ text_refund_failed|e('js') }}: ' + json['error']);
            } else if (json['success']) {
                alert('{{ text_refund_success|e('js') }}: ' + json['success']);
                $('#refund-modal').modal('hide');
                // 刷新页面
                location.reload();
            } else {
                alert('{{ text_refund_unknown_error|e('js') }}');
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert('{{ text_refund_failed|e('js') }}: ' + thrownError);
        }
    });
});
</script>
</div>
{{ footer }} 
]]></add>
    </operation>
  </file>
</modification>
