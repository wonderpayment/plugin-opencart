<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title"><i class="fa fa-credit-card"></i> {{ heading_title }}</h3>
  </div>
  <div class="panel-body">
    {% if payment_info %}
    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <td class="text-left" colspan="2">{{ text_payment_info }}</td>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="text-left" style="width: 50%;">{{ text_reference_number }}</td>
            <td class="text-left">{{ reference_number }}</td>
          </tr>
          <tr>
            <td class="text-left">{{ text_payment_status }}</td>
            <td class="text-left">
              {% if payment_status == 'paid' %}
                <span class="label label-success">{{ text_status_paid }}</span>
              {% elseif payment_status == 'pending' %}
                <span class="label label-warning">{{ text_status_pending }}</span>
              {% else %}
                <span class="label label-default">{{ payment_status }}</span>
              {% endif %}
            </td>
          </tr>
          <tr>
            <td class="text-left">{{ text_total }}</td>
            <td class="text-left">{{ total }}</td>
          </tr>
          <tr>
            <td class="text-left">{{ text_total_refunded }}</td>
            <td class="text-left">{{ total_refunded }}</td>
          </tr>
          <tr>
            <td class="text-left">{{ text_total_refunded_settlement }}</td>
            <td class="text-left">{{ total_refunded_settlement }}</td>
          </tr>
          <tr>
            <td class="text-left">{{ text_available_refund }}</td>
            <td class="text-left">{{ available_refund }}</td>
          </tr>
          <tr>
            <td class="text-left">{{ text_available_refund_settlement }}</td>
            <td class="text-left">{{ available_refund_settlement }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    {% if payment_status == 'paid' and available_refund_value > 0 %}
    <div class="well">
      <h4>{{ text_create_refund }}</h4>
      
      <!-- 退款类型选择 -->
      <div class="form-group">
        <label class="control-label">{{ text_refund_type }}</label>
        <div class="radio">
          <label>
            <input type="radio" name="refund_type" value="full" checked="checked" id="refund-type-full"/>
            {{ text_full_refund }} ({{ available_refund }})
          </label>
        </div>
        <div class="radio">
          <label>
            <input type="radio" name="refund_type" value="partial" id="refund-type-partial"/>
            {{ text_partial_refund }}
          </label>
        </div>
      </div>
      
      <!-- 部分退款金额输入框 -->
      <div class="form-group" id="partial-amount-group" style="display: none;">
        <label class="control-label" for="input-refund-amount">{{ text_refund_amount }}</label>
        <div class="input-group">
          <input type="number" id="input-refund-amount" name="refund_amount" value="{{ available_refund_value }}" step="0.01" min="0.01" max="{{ available_refund_value }}" class="form-control"/>
          <span class="input-group-addon">{{ currency_code }}</span>
        </div>
        <p class="help-block">{{ text_max_refund_amount }}: {{ available_refund }}</p>
      </div>
      
      <div class="form-group">
        <label class="control-label" for="input-transaction-uuid">{{ text_transaction_uuid }}</label>
        <input type="text" id="input-transaction-uuid" name="transaction_uuid" value="" class="form-control" placeholder="{{ text_enter_transaction_uuid }}"/>
        <p class="help-block">{{ text_transaction_uuid_help }}</p>
      </div>
      <div class="text-right">
        <button type="button" id="button-refund" data-loading-text="{{ text_loading }}" class="btn btn-primary"><i class="fa fa-undo"></i> {{ button_refund }}</button>
      </div>
    </div>
    {% endif %}

    {% if refunds %}
    <h4>{{ text_refund_history }}</h4>
    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <td class="text-left">{{ text_refund_id }}</td>
            <td class="text-left">{{ text_amount }}</td>
            <td class="text-left">{{ text_transaction_uuid }}</td>
            <td class="text-left">{{ text_status }}</td>
            <td class="text-left">{{ text_date_added }}</td>
          </tr>
        </thead>
        <tbody>
          {% for refund in refunds %}
          <tr>
            <td class="text-left">#{{ refund.refund_id }}</td>
            <td class="text-left">{{ refund.amount }}</td>
            <td class="text-left">{{ refund.transaction_uuid }}</td>
            <td class="text-left">
              {% if refund.status == 'success' %}
                <span class="label label-success">{{ text_status_success }}</span>
              {% elseif refund.status == 'pending' %}
                <span class="label label-warning">{{ text_status_pending }}</span>
              {% elseif refund.status == 'failed' %}
                <span class="label label-danger">{{ text_status_failed }}</span>
              {% else %}
                <span class="label label-default">{{ refund.status }}</span>
              {% endif %}
            </td>
            <td class="text-left">{{ refund.date_added }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center">{{ text_no_refunds }}</div>
    {% endif %}

    {% else %}
    <div class="text-center">{{ text_no_payment_info }}</div>
    {% endif %}
  </div>
</div>

<script type="text/javascript">
var refundCurrency = '{{ currency_code|e('js') }}';
var settlementCurrency = '{{ settlement_currency|e('js') }}';
var refundRate = {{ refund_rate }};

// 处理退款类型选择
$('input[name="refund_type"]').on('change', function() {
    if ($(this).val() === 'partial') {
        $('#partial-amount-group').show();
    } else {
        $('#partial-amount-group').hide();
        // 全额退款时设置金额为可退金额
        $('#input-refund-amount').val($('#input-refund-amount').attr('max'));
    }
});

$('#button-refund').on('click', function() {
    var refundType = $('input[name="refund_type"]:checked').val();
    var refundAmount = 0;
    
    if (refundType === 'full') {
        // 全额退款使用最大可退金额
        refundAmount = parseFloat($('#input-refund-amount').attr('max'));
        $('#input-refund-amount').val(refundAmount);
    } else {
        // 部分退款使用用户输入的金额
        refundAmount = parseFloat($('#input-refund-amount').val());
    }
    
    // 验证退款金额
    var maxAmount = parseFloat($('#input-refund-amount').attr('max'));
    if (refundAmount <= 0 || refundAmount > maxAmount) {
        alert('{{ text_invalid_refund_amount }}');
        return false;
    }

    $.ajax({
        url: 'index.php?route=extension/payment/wonderpayment/refund&user_token={{ user_token }}',
        type: 'post',
        dataType: 'json',
        data: 'refund_type=' + refundType + '&' + $('#input-transaction-uuid').serialize() + '&order_id={{ order_id }}&refund_amount=' + refundAmount,
        beforeSend: function() {
            $('#button-refund').button('loading');
        },
        complete: function() {
            $('#button-refund').button('reset');
        },
        success: function(json) {
            $('.alert-dismissible').remove();

            if (json['error']) {
                $('#content > .container-fluid').prepend('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> ' + json['error'] + ' <button type="button" class="close" data-dismiss="alert">&times;</button></div>');
            }

            if (json['success']) {
                $('#content > .container-fluid').prepend('<div class="alert alert-success alert-dismissible"><i class="fa fa-check-circle"></i> ' + json['success'] + ' <button type="button" class="close" data-dismiss="alert">&times;</button></div>');

                // 刷新页面以显示更新的退款信息
                setTimeout(function() {
                    location.reload();
                }, 2000);
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});
</script>
